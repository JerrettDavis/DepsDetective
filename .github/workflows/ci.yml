name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  workflow-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint GitHub workflows
        uses: rhysd/actionlint@v1

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Lint
        run: ruff check .
      - name: Tests
        run: pytest

  ecosystem-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - stack: python
            tests: tests/test_python_requirements_updater.py tests/test_python_pyproject_scanner.py tests/test_python_pyproject_updater.py tests/test_runner_integration.py::test_run_bot_triggers_provider_workflow_without_real_pr
          - stack: node
            tests: tests/test_node_package_updater.py tests/test_runner_integration.py::test_run_bot_autodetects_node_and_updates_package_json
          - stack: dotnet
            tests: tests/test_dotnet_scanner.py tests/test_dotnet_updater.py tests/test_runner_integration.py::test_run_bot_autodetects_dotnet_and_updates_csproj
          - stack: go
            tests: tests/test_go_mod_scanner.py tests/test_go_mod_updater.py tests/test_runner_integration.py::test_run_bot_autodetects_go_and_updates_go_mod
          - stack: maven
            tests: tests/test_maven_scanner.py tests/test_maven_updater.py tests/test_runner_integration.py::test_run_bot_autodetects_maven_and_updates_pom
          - stack: rust
            tests: tests/test_rust_scanner.py tests/test_rust_updater.py tests/test_runner_integration.py::test_run_bot_autodetects_rust_and_updates_cargo
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Validate stack update flow (${{ matrix.stack }})
        run: pytest -q ${{ matrix.tests }}

  provider-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Validate provider adapters
        run: pytest -q tests/test_providers.py tests/test_provider_azure_devops_api.py tests/test_runner_integration.py::test_run_bot_triggers_provider_workflow_without_real_pr tests/test_runner_integration.py::test_run_bot_dry_run_triggers_workflow_but_does_not_push_or_call_provider

  docker-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: docker build -t depdetective:ci .
      - name: Smoke test CLI
        run: |
          docker run --rm depdetective:ci --help
          docker run --rm depdetective:ci run \
            --repo-url https://github.com/octocat/Hello-World.git \
            --provider github \
            --auto-detect \
            --dry-run
